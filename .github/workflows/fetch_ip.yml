name: Update IP and Time (BJ)

on:
  schedule:
    # GitHub 免费版限制最小间隔约 5 分钟
    - cron: '*/5 * * * *'
  workflow_dispatch:

# 必须赋予写权限才能提交代码
permissions:
  contents: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      - name: Run Script to Fetch and Sort IPs
        run: |
          # 使用 'EOF' 避免 Shell 变量干扰 Python 脚本
          cat << 'EOF' > run_script.py
          import requests
          from bs4 import BeautifulSoup
          import re
          import sys
          from datetime import datetime, timedelta, timezone

          def get_sorted_ips():
              urls = [
                  ("EdgeOne", "https://www.wetest.vip/page/edgeone/address_v4.html"),
                  ("CloudFlare", "https://www.wetest.vip/page/cloudflare/address_v4.html")
              ]
              
              all_data = []
              headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}

              print("开始抓取数据...")
              for name, url in urls:
                  try:
                      print(f"正在访问: {name}...")
                      resp = requests.get(url, headers=headers, timeout=15)
                      if resp.status_code != 200:
                          print(f"无法访问 {name}, 状态码: {resp.status_code}")
                          continue
                          
                      soup = BeautifulSoup(resp.text, 'html.parser')
                      rows = soup.find_all('tr')
                      print(f"在 {name} 找到 {len(rows)} 行数据")

                      for tr in rows:
                          tds = tr.find_all('td')
                          if len(tds) < 4: continue
                          
                          try:
                              # 第2列是IP，第4列是速度
                              ip = tds[1].get_text(strip=True)
                              speed_str = tds[3].get_text(strip=True)
                              
                              # 提取数字速度
                              speed_match = re.search(r'(\d+)', speed_str)
                              if speed_match:
                                  speed = int(speed_match.group(1))
                                  # 简单的 IP 格式校验
                                  if ip.count('.') == 3:
                                      all_data.append({'ip': ip, 'speed': speed, 'source': name})
                          except Exception as e:
                              continue
                  except Exception as e:
                      print(f"抓取 {name} 出错: {e}")

              # --- 核心逻辑：按速度降序排序 (最快在前) ---
              all_data.sort(key=lambda x: x['speed'], reverse=True)
              return all_data

          if __name__ == "__main__":
              # 1. 准备时间 (北京时间 UTC+8)
              utc_now = datetime.now(timezone.utc)
              bj_time = utc_now + timedelta(hours=8)
              time_str = bj_time.strftime('%Y-%m-%d %H:%M:%S')

              # 2. 获取并排序 IP 数据
              data = get_sorted_ips()
              log_msg = ""
              
              if data:
                  ip_count = len(data)
                  best_item = data[0]
                  print(f"共获取到 {ip_count} 个有效 IP，最快速度: {best_item['speed']} kB/s")
                  
                  # --- 写入 IP.txt (全量排序写入) ---
                  # 覆盖模式 'w'，每次写入最新的完整列表
                  with open('IP.txt', 'w', encoding='utf-8') as f:
                      for item in data:
                          # 写入格式：仅 IP，每行一个
                          f.write(f"{item['ip']}\n")
                  
                  # 同时保留 top_ip.txt (仅写入最快的一个，可选)
                  with open('top_ip.txt', 'w', encoding='utf-8') as f:
                      f.write(best_item['ip'])

                  # 构造日志信息
                  log_msg = f"[{time_str}] 成功更新 {ip_count} 个IP - 最快: {best_item['ip']} ({best_item['speed']} kB/s)\n"
              else:
                  print("未找到有效 IP 数据")
                  log_msg = f"[{time_str}] 更新失败 - 未找到有效数据\n"

              # 3. 写入日志 (追加模式 'a')
              with open('update_log.txt', 'a', encoding='utf-8') as f:
                  f.write(log_msg)

          EOF

          # 执行 Python 脚本
          python run_script.py

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 添加生成的文件 (注意加入了 IP.txt)
          git add IP.txt top_ip.txt update_log.txt
          
          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "没有需要提交的变更"
          else
            CURRENT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            git commit -m "Auto update sorted IPs: $CURRENT_TIME"
            git push
            echo "更新已推送"
          fi
