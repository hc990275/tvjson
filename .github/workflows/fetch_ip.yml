name: Fetch and Update Cloudflare IP List

# 保持为15分钟，因为1分钟过于频繁，且我们已经排除了时间间隔大的问题
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  fetch_and_commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch, Extract, and Save IP data (Diagnostic Mode)
        run: |
          IP_URL="https://www.wetest.vip/page/cloudflare/address_v4.html"
          
          echo "开始从 ${IP_URL} 抓取数据并保存到临时文件..."
          # 1. 使用 curl 抓取网页内容并保存到临时文件
          curl -s $IP_URL > raw_html.txt
          
          # 2. 【核心诊断步骤】打印包含 IP 地址的关键 HTML 片段到日志
          echo "----------------------------------------"
          echo "工作流抓取到的原始 HTML 片段 (用于对比):"
          # 打印所有包含 '优选地址' 标签的行
          grep '<td data-label="优选地址">' raw_html.txt
          echo "----------------------------------------"
          
          # 3. 从临时文件中提取 IP 并保存到 IP.txt
          grep -oP '<td data-label="优选地址">\K[0-9.]+' raw_html.txt > IP.txt

          # 4. 检查 IP.txt 是否有数据
          if [ -s IP.txt ]; then
            echo "成功提取 $(wc -l < IP.txt) 个 IP 地址到 IP.txt。"
          else
            echo "警告：IP.txt 文件为空，请检查 URL 或提取正则是否正确！"
            exit 1 
          fi

      - name: Commit and push changes
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          
          if git diff --quiet IP.txt; then
            echo "IP.txt 内容无变化，跳过提交。"
          else
            echo "检测到 IP.txt 内容有更新，正在提交并推送..."
            git add IP.txt
            git commit -m "chore(auto): Update Cloudflare IP list via GitHub Actions"
            git push
            echo "提交推送完成。"
          fi
