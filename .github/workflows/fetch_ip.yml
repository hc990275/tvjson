name: ğŸš€ Fetch & Rank Best IPs (1 Min Cycle)

# 1. è§¦å‘äº‹ä»¶ï¼šä¿æŒæ¯åˆ†é’Ÿè¿è¡Œ
on:
  schedule:
    # '*/1 * * * *' è¡¨ç¤ºæ¯å°æ—¶çš„æ¯åˆ†é’Ÿéƒ½è¿è¡Œä¸€æ¬¡
    # æ³¨æ„ï¼šGitHub Actions çš„æœ€ä½æ‰§è¡Œé—´éš”é€šå¸¸ä¸º 5 åˆ†é’Ÿã€‚
    - cron: '*/1 * * * *' 
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  fetch_and_rank:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    # èµ‹äºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿æäº¤æ›´æ”¹åˆ°ä»“åº“
    permissions:
      contents: write 

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å®‰è£…ä¾èµ–åº“ï¼ˆrequests å’Œ beautifulsoup4 ç”¨äºç½‘é¡µè§£æï¼‰
      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      # 4. æ‰§è¡Œ IP æŠ“å–ã€æ’åå¹¶ä¿å­˜ç»“æœ
      # **æ³¨æ„ï¼šç¬¬ 39 è¡Œåœ¨ Shell å—å†…ï¼Œå·²ç¡®ä¿ Python ä»£ç æ²¡æœ‰å‰å¯¼ç©ºæ ¼ï¼Œä»è€Œé¿å… YAML é”™è¯¯ã€‚**
      - name: Run IP Fetching and Ranking Script
        run: |
          # å°† Python è„šæœ¬å†…åµŒåˆ°å·¥ä½œæµä¸­
          cat << EOF > rank_script.py
import requests
from bs4 import BeautifulSoup
import re

# å®šä¹‰ä¸¤ä¸ªç›®æ ‡ URL
URLS = {
    "EdgeOne": "https://www.wetest.vip/page/edgeone/address_v4.html",
    "CloudFlare": "https://www.wetest.vip/page/cloudflare/address_v4.html"
}

def fetch_and_parse(url, source_name):
    print(f"--- æ­£åœ¨ä» {source_name} æŠ“å–æ•°æ®: {url} ---")
    headers = {'User-Agent': 'Mozilla/5.0 (GitHub Actions)'}
    
    # å°è¯•æŠ“å–æ•°æ®ï¼Œå¹¶è®¾ç½®è¶…æ—¶
    try:
        response = requests.get(url, headers=headers, timeout=15)
        response.raise_for_status() # æ£€æŸ¥HTTPé”™è¯¯
    except requests.exceptions.RequestException as e:
        print(f"é”™è¯¯: æ— æ³•è®¿é—® {source_name}: {e}")
        return []

    soup = BeautifulSoup(response.text, 'html.parser')
    data_list = []
    
    # å®šä½åˆ°æ•°æ®è¡¨æ ¼
    table = soup.find('table')
    if not table:
        print(f"è­¦å‘Š: åœ¨ {source_name} é¡µé¢æœªæ‰¾åˆ°æ•°æ®è¡¨æ ¼ã€‚")
        return []

    # éå†æ‰€æœ‰è¡Œ
    for row in table.find_all('tr'):
        columns = row.find_all('td')
        
        # ç¡®ä¿è¡Œæœ‰è¶³å¤Ÿçš„åˆ—
        if len(columns) < 5: 
            continue 

        # æ ¸å¿ƒæ•°æ®æå–
        try:
            line_name = columns[0].text.strip()
            ip_address = columns[1].text.strip()
            speed_text = columns[3].text.strip() 

            # æå–é€Ÿåº¦å€¼ï¼ˆè½¬æ¢ä¸ºæ•´æ•°ç”¨äºæ’åºï¼‰
            match = re.search(r'(\d+)\s?kB/s', speed_text)
            if match:
                speed_value = int(match.group(1)) # æå–æ•°å­—éƒ¨åˆ†
            else:
                continue
            
            data_list.append({
                'å³°å€¼é€Ÿåº¦_æ•°å€¼': speed_value,
                'ä¼˜é€‰åœ°å€': ip_address,
                'çº¿è·¯åç§°': line_name,
                'æ¥æº': source_name
            })
        except IndexError:
            continue
            
    return data_list

# --- ä¸»é€»è¾‘ ---
all_data = []
for source, url in URLS.items():
    all_data.extend(fetch_and_parse(url, source))

if not all_data:
    print("æ²¡æœ‰æˆåŠŸæå–åˆ°ä»»ä½• IP æ•°æ®ã€‚")
    exit(0) 

# 5. æ’åºï¼šæŒ‰é€Ÿåº¦é™åºæ’åˆ—
sorted_data = sorted(
    all_data, 
    key=lambda x: x['å³°å€¼é€Ÿåº¦_æ•°å€¼'], 
    reverse=True
)

# 6. ä¿å­˜æ’åç¬¬ä¸€çš„ IP åœ°å€åˆ°æ–‡ä»¶ (ä¾›æºç¨‹ä½¿ç”¨)
output_filename = "top_ip.txt" 
with open(output_filename, "w", encoding="utf-8") as f:
    if sorted_data:
        best_ip = sorted_data[0]['ä¼˜é€‰åœ°å€']
        f.write(best_ip + "\n")
        
        print(f"\n--- æœ€ä½³ IP åœ°å€å·²ä¿å­˜åˆ° {output_filename} ---")
        print(f"æ’åç¬¬ä¸€çš„ IP: {best_ip}")
        print(f"é€Ÿåº¦: {sorted_data[0]['å³°å€¼é€Ÿåº¦_æ•°å€¼']} kB/s")
        print(f"æ¥æº: {sorted_data[0]['æ¥æº']}")
    else:
        print("è­¦å‘Šï¼šæ’åºååˆ—è¡¨ä¸ºç©ºï¼Œæœªç”Ÿæˆ top_ip.txt æ–‡ä»¶ã€‚")

EOF

          # æ‰§è¡Œ Python è„šæœ¬
          python rank_script.py
      
      # 5. æäº¤å’Œæ¨é€æ›´æ”¹ï¼ˆä»…åœ¨ top_ip.txt æœ‰å˜åŒ–æ—¶ï¼‰
      - name: Commit and push changes
        run: |
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          
          # æ£€æŸ¥ top_ip.txt æ–‡ä»¶å†…å®¹æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet top_ip.txt; then
            echo "top_ip.txt å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            echo "æ£€æµ‹åˆ° top_ip.txt å†…å®¹æœ‰æ›´æ–°ï¼Œæ­£åœ¨æäº¤å¹¶æ¨é€..."
            git add top_ip.txt
            # ç®€åŒ–æäº¤ä¿¡æ¯ï¼Œç¡®ä¿å·¥ä½œæµæˆåŠŸ
            git commit -m "chore(auto): Update best ranked IP" 
            git push
            echo "æäº¤æ¨é€å®Œæˆã€‚"
          fi
