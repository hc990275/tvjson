name: Auto Fetch Best IP

on:
  schedule:
    # GitHub Actions 免费版最小间隔约为 5 分钟
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-ip:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      - name: Run Extraction Script
        run: |
          cat << 'EOF' > extract.py
          import requests
          from bs4 import BeautifulSoup
          import re
          import sys

          def get_ips():
              urls = [
                  ("EdgeOne", "https://www.wetest.vip/page/edgeone/address_v4.html"),
                  ("CloudFlare", "https://www.wetest.vip/page/cloudflare/address_v4.html")
              ]
              
              all_data = []
              headers = {'User-Agent': 'Mozilla/5.0'}

              for name, url in urls:
                  try:
                      print(f"Fetching {name}...")
                      resp = requests.get(url, headers=headers, timeout=20)
                      if resp.status_code != 200:
                          continue
                          
                      soup = BeautifulSoup(resp.text, 'html.parser')
                      # 查找包含"峰值速度"的表格行
                      for tr in soup.find_all('tr'):
                          tds = tr.find_all('td')
                          if len(tds) < 4: continue
                          
                          # 提取 IP (通常在第2列) 和 速度 (通常在第4列)
                          # 根据网页结构调整索引: 0:线路, 1:IP, 2:带宽, 3:速度
                          try:
                              ip = tds[1].get_text(strip=True)
                              speed_str = tds[3].get_text(strip=True)
                              
                              # 正则提取数字速度 (kB/s)
                              speed_match = re.search(r'(\d+)', speed_str)
                              if speed_match and re.match(r'^\d{1,3}(\.\d{1,3}){3}$', ip):
                                  speed = int(speed_match.group(1))
                                  all_data.append({'ip': ip, 'speed': speed, 'source': name})
                          except:
                              continue
                  except Exception as e:
                      print(f"Error fetching {name}: {e}")

              # 排序：速度从大到小
              all_data.sort(key=lambda x: x['speed'], reverse=True)
              return all_data

          if __name__ == "__main__":
              data = get_ips()
              if data:
                  best_ip = data[0]['ip']
                  print(f"Best IP found: {best_ip} with speed {data[0]['speed']} kB/s")
                  
                  # 写入文件
                  with open('top_ip.txt', 'w') as f:
                      f.write(best_ip)
              else:
                  print("No data found")
                  sys.exit(0)
          EOF
          
          python extract.py

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f "top_ip.txt" ]; then
            git add top_ip.txt
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Auto-update Best IP"
              git push
            fi
          else
            echo "top_ip.txt does not exist, skipping commit"
          fi
