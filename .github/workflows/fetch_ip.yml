name: Update IP and Time (BJ)

on:
  schedule:
    # GitHub 免费版限制最小间隔约 5 分钟
    - cron: '*/5 * * * *'
  workflow_dispatch:

# 必须赋予写权限才能提交代码
permissions:
  contents: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      - name: Run Script to Fetch IP and Log Time
        run: |
          # 使用 'EOF' 避免 Shell 变量干扰 Python 脚本
          cat << 'EOF' > run_script.py
          import requests
          from bs4 import BeautifulSoup
          import re
          import sys
          from datetime import datetime, timedelta, timezone

          def get_best_ip():
              urls = [
                  ("EdgeOne", "https://www.wetest.vip/page/edgeone/address_v4.html"),
                  ("CloudFlare", "https://www.wetest.vip/page/cloudflare/address_v4.html")
              ]
              
              all_data = []
              headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}

              print("开始抓取数据...")
              for name, url in urls:
                  try:
                      print(f"正在访问: {name}...")
                      resp = requests.get(url, headers=headers, timeout=15)
                      if resp.status_code != 200:
                          print(f"无法访问 {name}, 状态码: {resp.status_code}")
                          continue
                          
                      soup = BeautifulSoup(resp.text, 'html.parser')
                      rows = soup.find_all('tr')
                      print(f"在 {name} 找到 {len(rows)} 行数据")

                      for tr in rows:
                          tds = tr.find_all('td')
                          if len(tds) < 4: continue
                          
                          try:
                              ip = tds[1].get_text(strip=True)
                              speed_str = tds[3].get_text(strip=True)
                              
                              speed_match = re.search(r'(\d+)', speed_str)
                              if speed_match:
                                  speed = int(speed_match.group(1))
                                  if ip.count('.') == 3:
                                      all_data.append({'ip': ip, 'speed': speed, 'source': name})
                          except Exception as e:
                              continue
                  except Exception as e:
                      print(f"抓取 {name} 出错: {e}")

              # 按速度降序排序
              all_data.sort(key=lambda x: x['speed'], reverse=True)
              return all_data

          if __name__ == "__main__":
              # 1. 准备时间 (北京时间 UTC+8)
              utc_now = datetime.now(timezone.utc)
              bj_time = utc_now + timedelta(hours=8)
              time_str = bj_time.strftime('%Y-%m-%d %H:%M:%S')

              # 2. 处理 IP 数据
              data = get_best_ip()
              log_msg = ""
              
              if data:
                  best_item = data[0]
                  best_ip = best_item['ip']
                  speed = best_item['speed']
                  source = best_item['source']
                  
                  print(f"找到最快 IP: {best_ip} (速度: {speed} kB/s, 来源: {source})")
                  
                  # 写入 top_ip.txt (覆盖模式，只保留最新IP)
                  with open('top_ip.txt', 'w', encoding='utf-8') as f:
                      f.write(best_ip)
                  
                  # 构造成功日志信息
                  log_msg = f"[{time_str}] 成功更新 - IP: {best_ip} | 速度: {speed} kB/s | 来源: {source}\n"
              else:
                  print("未找到有效 IP 数据")
                  # 构造失败日志信息
                  log_msg = f"[{time_str}] 更新失败 - 未找到有效数据\n"

              # 3. 写入日志 (追加模式 'a')
              print(f"写入日志内容: {log_msg.strip()}")
              with open('update_log.txt', 'a', encoding='utf-8') as f:
                  f.write(log_msg)

          EOF

          # 执行 Python 脚本
          python run_script.py

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 添加生成的文件 (注意这里改为了 update_log.txt)
          git add top_ip.txt update_log.txt
          
          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "没有需要提交的变更"
          else
            CURRENT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            git commit -m "Auto update IP and Log: $CURRENT_TIME"
            git push
            echo "更新已推送"
          fi
